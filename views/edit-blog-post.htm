<input type="text" name="blog-post-title">
<textarea style="width:100%; height:100%;" name="blog-post-content"></textarea>
<button type="submit" id="submit-button">Save</button>

<script>
    var titleField = document.querySelector("[name=blog-post-title]");
    var editorField = document.querySelector("[name=blog-post-content]");
    
    var name = getQueryVariable("name");
    
    if(name) {
        getUrl("_api/get-blog-post.php?name="+name, function(error, res) {
            if(error) {
                return console.error("Something went wrong! "+error);
            }
            titleField.setAttribute("value", res.title);
            editorField.innerHTML = res.content;
        });
    }
    else {
        titleField.innerHTML("New blog post");
        editorField.innerHTML = "";
    }
    
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            if (decodeURIComponent(pair[0]) == variable) {
                return decodeURIComponent(pair[1]);
            }
        }
        console.log('Query variable %s not found', variable);
    }
    
    function getUrl(url, callback) {
        var req = new XMLHttpRequest();
        req.open("GET", url);
        req.onreadystatechange = function() {
            if(req.readyState == 4) {
                try {
                    var res = JSON.parse(req.responseText);
                    if(res.error) {
                        return callback(res.error);
                    }
                    callback(null, res);
                }
                catch(e) {
                    callback(e);
                }
            }
        };
        req.send();
    }
    
    // ----
    
    var saveButton = document.querySelector("#submit-button");
    saveButton.addEventListener("click", function(e) {
        postUrl("_api/save-blog-post.php", {
            title: titleField.getAttribute("value"),
            content: getEditorContent()
        }, function(error, res) {
            if(error) {
                return console.error("Failed to save! "+error);
            }
            console.log("Saved! yay!");
        });
        return false;
    });
    
    function postUrl(url, data, callback) {
        var req = new XMLHttpRequest();
        req.open("POST", url);
        req.onreadystatechange = function() {
            if(req.readyState == 4) {
                try {
                    var res = JSON.parse(req.responseText);
                    if(res.error) {
                        return callback(res.error);
                    }
                    callback(null, res);
                }
                catch(e) {
                    callback(e+" - '"+req.responseText+"'");
                }
            }
        };
        req.send(JSON.stringify(data));
    }
    
    function getEditorContent() {
        return document.querySelector("[name=blog-post-content]").value;
    }
</script>